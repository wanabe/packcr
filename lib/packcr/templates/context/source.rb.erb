module Kernel
  def getb
    $stdin.readbyte
  rescue EOFError
    -1
  end
end

class <%= class_name %>
  def initialize
    @buffer = +"".b
    @pos = 0
    @cur = 0
    @level = 0
    @lrstack = []
    @thunks = []
    @lrtable = LrTable.new
<%- if @location -%>
    @pos_loc = Location.new
    @cur_loc = Location.new
<%- end -%>
  end

  def refill_buffer(num)
    len = @buffer.length
    if len >= @cur + num
      return len - @cur
    end
    while len < @cur + num
        c = getb
        break if c < 0
        @buffer << c
        len = @buffer.length
    end
    return len - @cur
  end

  def commit_buffer
    @buffer = @buffer[@cur, @buffer.length - @cur]
    @pos += @cur;
    @lrtable.shift(@cur)
    @cur = 0
    <%- if @location -%>
    @pos_loc = @pos_loc + @cur_loc
    @cur_loc = Location.new
    <%- end -%>
  end

  class LrTable
    def initialize
      super
      @buf = []
    end
  end
end

require_relative "<%= prefix%>.so"

class <%= class_name %>
  class ThunkChunk
    def initialize
      super
      @thunks = []
      @pos = 0
    end
  end
end
