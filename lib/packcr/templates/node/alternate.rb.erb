<%-   m = gen.next_label -%>
catch(<%= m %>) do
  pos<%= gen.level %> = @cur
  <%- if gen.location -%>
  p_loc<%= gen.level %> = @cur_loc
  <%- end -%>
  n<%= gen.level %> = answer.thunks.length
  <%- nodes.each_with_index do |expr, i| -%>
  <%-   c = i + 1 < nodes.length -%>
  <%- if expr.reversible?(gen) -%>
  <%-   r = expr.reachability -%>
  <%-   %><%= gen.generate_code(expr, m, 2, false, reverse: true, oncut: onfail) -%>
  <%- else -%>
  <%-   l = gen.next_label -%>
  catch(<%= l %>) do
    <%-   r = expr.reachability -%>
    <%-   %><%= gen.generate_code(expr, l, 4, false, oncut: onfail) -%>
    <%-   if r == Packcr::CODE_REACH__ALWAYS_SUCCEED -%>
    <%-     if c -%>
    # unreachable codes omitted
    <%-     end -%>
  end
    <%-     break -%>
    <%-   else -%>
    <%-     if r == Packcr::CODE_REACH__BOTH -%>
    throw(<%= m %>)
    <%-     end -%>
    <%-   end -%>
  end
  <%- end -%>
  @cur = pos<%= gen.level %>
  <%- if gen.location -%>
  @cur_loc = p_loc<%= gen.level %>
  <%- end -%>
  answer.thunks[n<%= gen.level %>..-1] = []
  <%-   if !c -%>
  throw(<%= onfail %>)
  <%-   end -%>
  <%- end -%>
end
