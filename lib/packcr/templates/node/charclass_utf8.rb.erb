1.times do |;u, n|
  n, u = get_utf8_char_range_and_codepoint
  if n == 0
    throw(<%= onfail %>)
  end
  <%- if charclass && !(a && n == 1) # not '.' or '[^]' -%>
  <%-   u0 = 0 -%>
  <%-   r = false -%>
  <%-   if a -%>
  if (
  <%-   else -%>
  if (!(
    <%-   end -%>
    <%-   while i < n -%>
    <%-     if charclass[i] == '\\' && i + 1 < n -%>
    <%-       i += 1 -%>
    <%-     end -%>
    <%-     u = charclass[i].ord -%>
    <%-     i += 1 -%>
    <%-     if r -%>
    <%-       # character range -%>
    (u >= 0x<%= "%06x" % u0  %> && u <= 0x<%= "%06x" % u %>)<% if i < n %> ||<% end %>
    <%-       u0 = 0 -%>
    <%-       r = false -%>
    <%-     elsif charclass[i] != "-" || i == n - 1 # the individual '-' character is valid when it is at the first or the last position -%>
    <%-       # single character -%>
    u == 0x<%= "%06x" % u %><% if i < n %> ||<% end %>
    <%-       u0 = 0 -%>
    <%-       r = false -%>
    <%-     elsif charclass[i] == "-" -%>
    <%-       i += 1 -%>
    <%-       u0 = u -%>
    <%-       r = true -%>
    <%-     else -%>
    <%-       raise "unexpected charclass #{charclass[i]}" -%>
    <%-     end -%>
    <%-   end -%>
    <%-   if a -%>
  )
  <%-   else -%>
  ))
  <%-   end -%>
    throw(<%= onfail %>)
  end
  <%- end -%>
  <%- if gen.location -%>
  @cur_loc = @cur_loc.forward(@buffer, @cur, n)
  <%- end -%>
  @cur += n
end
