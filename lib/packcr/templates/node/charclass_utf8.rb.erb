{
    int u;
    const size_t n = pcc_get_char_as_utf32(rctx, &u);
    if (n == 0) goto L<%= "%04d" % onfail %>;
<%- if charclass && !(a && n == 1) # not '.' or '[^]' -%>
<%-   u0 = 0 -%>
<%-   r = false -%>
<%-   if a -%>
    if (
<%-   else -%>
    if (!(
<%-   end -%>
<%-   while i < n -%>
<%-     if charclass[i] == '\\' && i + 1 < n -%>
<%-       i += 1 -%>
<%-     end -%>
<%-     u = charclass[i].ord -%>
<%-     i += 1 -%>
<%-     if r -%>
<%-       # character range -%>
        (u >= 0x<%= "%06x" % u0  %> && u <= 0x<%= "%06x" % u %>)<% if i < n %> ||<% end %>
<%-       u0 = 0 -%>
<%-       r = false -%>
<%-     elsif charclass[i] != "-" || i == n - 1 # the individual '-' character is valid when it is at the first or the last position -%>
<%-       # single character -%>
        u == 0x<%= "%06x" % u %><% if i < n %> ||<% end %>
<%-       u0 = 0 -%>
<%-       r = false -%>
<%-     elsif charclass[i] == "-" -%>
<%-       i += 1 -%>
<%-       u0 = u -%>
<%-       r = true -%>
<%-     else -%>
<%-       raise "unexpected charclass #{charclass[i]}" -%>
<%-     end -%>
<%-   end -%>
<%-   if a -%>
    ) goto L<%= "%04d" % onfail %>;
<%-   else -%>
    )) goto L<%= "%04d" % onfail %>;
<%-   end -%>
<%- end -%>
<%- if gen.location -%>
    rb_funcall(rb_ivar_get(rctx, rb_intern("@cur_loc")), rb_ivar_get(rctx, rb_intern("@buffer")), rb_ivar_get(rctx, rb_intern("@cur")), SIZET2NUM(n));
<%- end -%>
    rb_ivar_set(rctx, rb_intern("@cur"), SIZET2NUM(NUM2SIZET(rb_ivar_get(rctx, rb_intern("@cur"))) + n));
}
