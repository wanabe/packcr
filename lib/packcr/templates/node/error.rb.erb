{
<%= code -%>
    goto L<%= "%04d" % m %>;
L<%= "%04d" % l %>:;
    {
        pcc_thunk_t *const thunk = pcc_thunk__create_leaf(NULL, rb_intern("action_<%= gen.rule.name %>_<%= index %>"), <%= gen.rule.vars.length %>, <%= gen.rule.capts.length %>);
        VALUE rcapt0 = rb_ivar_get(thunk->robj, rb_intern("@capt0"));
        pcc_capture_t *capt0;
<%- if !vars.empty? -%>
        VALUE rvalue, rvalues = rb_ivar_get(rchunk, rb_intern("@values"));
        VALUE rvalue_refs = rb_ivar_get(thunk->robj, rb_intern("@value_refs"));
<%- end -%>
<%- if !capts.empty? -%>
        VALUE rcapt;
        pcc_capture_t *capt;
<%- end -%>
        TypedData_Get_Struct(rcapt0, pcc_capture_t, &pcc_capture_data_type, capt0);
<%- vars.each do |var| -%>
        rvalue = rb_funcall(rvalues, rb_intern("[]"), 1, SIZET2NUM(<%= var.index %>));
        rb_funcall(rvalue_refs, rb_intern("[]="), 2, SIZET2NUM(<%= var.index %>), rvalue);
<%- end -%>
<%- capts.each do |capt| -%>
        rcapt = rb_funcall(rb_ivar_get(rchunk, rb_intern("@capts")), rb_intern("[]"), 1, SIZET2NUM(<%= capt.index %>));
        rb_funcall(rb_ivar_get(thunk->robj, rb_intern("@capts")), rb_intern("[]="), 2, SIZET2NUM(<%= capt.index %>), rcapt);
<%- end -%>
        capt0->range.start = NUM2SIZET(rb_ivar_get(rchunk, rb_intern("@pos")));
        capt0->range.end = NUM2SIZET(rb_ivar_get(rctx, rb_intern("@cur")));
<%- if gen.location -%>
        capt0->range.start_loc = rb_ivar_get(rchunk, rb_intern("@pos_loc"));
        capt0->range.end_loc = rb_ivar_get(rctx, rb_intern("cur_loc"));
<%- end -%>
        rb_funcall(rctx, SYM2ID(rb_ivar_get(thunk->robj, rb_intern("@action"))), 3, thunk->robj, Qnil, SIZET2NUM(0));
    }
    goto L<%= "%04d" % onfail %>;
L<%= "%04d" % m %>:;
}
