{
<%= code -%>
    goto L<%= "%04d" % m %>;
L<%= "%04d" % l %>:;
    {
        VALUE rthunk = pcc_thunk__create_leaf(NULL, rb_intern("action_<%= gen.rule.name %>_<%= index %>"), <%= gen.rule.vars.length %>, <%= gen.rule.capts.length %>);
        VALUE rcapt0 = rb_ivar_get(rthunk, rb_intern("@capt0"));
<%- if !vars.empty? -%>
        VALUE rvalue, rvalues = rb_ivar_get(rchunk, rb_intern("@values"));
        VALUE rvalue_refs = rb_ivar_get(rthunk, rb_intern("@value_refs"));
<%- end -%>
<%- if !capts.empty? -%>
        VALUE rcapt;
<%- end -%>
<%- vars.each do |var| -%>
        rvalue = rb_funcall(rvalues, rb_intern("[]"), 1, SIZET2NUM(<%= var.index %>));
        rb_funcall(rvalue_refs, rb_intern("[]="), 2, SIZET2NUM(<%= var.index %>), rvalue);
<%- end -%>
<%- capts.each do |capt| -%>
        rcapt = rb_funcall(rb_ivar_get(rchunk, rb_intern("@capts")), rb_intern("[]"), 1, SIZET2NUM(<%= capt.index %>));
        rb_funcall(rb_ivar_get(rthunk, rb_intern("@capts")), rb_intern("[]="), 2, SIZET2NUM(<%= capt.index %>), rcapt);
<%- end -%>
        rb_ivar_set(rcapt0, rb_intern("@range_start"), rb_ivar_get(rchunk, rb_intern("@pos")));
        rb_ivar_set(rcapt0, rb_intern("@range_end"), rb_ivar_get(rctx, rb_intern("@cur")));
<%- if gen.location -%>
        rb_ivar_set(rcapt0, rb_intern("@start_loc"), rb_ivar_get(rchunk, rb_intern("@pos_loc")));
        rb_ivar_set(rcapt0, rb_intern("@end_loc"), rb_ivar_get(rctx, rb_intern("@cur_loc")));
<%- end -%>
        rb_funcall(rctx, SYM2ID(rb_ivar_get(rthunk, rb_intern("@action"))), 3, rthunk, Qnil, SIZET2NUM(0));
    }
    goto L<%= "%04d" % onfail %>;
L<%= "%04d" % m %>:;
}
