{
    const size_t p = NUM2SIZET(rb_ivar_get(rctx, rb_intern("@cur")));
    size_t q;
    VALUE rcapt;
<%- if gen.location -%>
    const VALUE p_loc = rb_ivar_get(rctx, rb_intern("@cur_loc"));
    VALUE q_loc;
<%- end -%>
<%- r, code = gen.generate_code_str(expr, onfail, 4, false) -%>
<%= code -%>
    q = NUM2SIZET(rb_ivar_get(rctx, rb_intern("@cur")));
    rcapt = rb_funcall(rb_ivar_get(rchunk, rb_intern("@capts")), rb_intern("[]"), 1, SIZET2NUM(<%= index %>));
    rb_ivar_set(rcapt, rb_intern("@range_start"), SIZET2NUM(p));
    rb_ivar_set(rcapt, rb_intern("@range_end"), SIZET2NUM(q));
<%- if gen.location -%>
    q_loc = rb_ivar_get(rctx, rb_intern("@cur_loc"));
    rb_ivar_set(rcapt, rb_intern("@range_start"), p_loc);
    rb_ivar_set(rcapt, rb_intern("@range_end"), q_loc);
<%- end -%>
}
